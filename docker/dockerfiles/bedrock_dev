FROM quay.io/deis/base:0.2.0

ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

EXPOSE 8000
CMD ["./docker/run-dev.sh"]

RUN apt-get update && \
    apt-get install -y --no-install-recommends python2.7 libpython2.7 gettext build-essential libxml2-dev libxslt1.1 libxslt1-dev python-dev python-pip python-setuptools nodejs npm git postgresql-client libpq-dev
RUN update-alternatives --install /usr/bin/node node /usr/bin/nodejs 10

ENV NODE_PATH=/node_modules
ENV PIPELINE_LESS_BINARY=/node_modules/.bin/lessc
ENV PIPELINE_UGLIFYJS_BINARY=/node_modules/.bin/uglifyjs
ENV PIPELINE_CSSMIN_BINARY=/node_modules/.bin/cssmin
COPY package.json /
RUN npm install
RUN cd /node_modules/.bin; for bin in *; do ln -s /node_modules/.bin/$bin /usr/local/bin/$bin; done; cd -

WORKDIR /app

COPY ./requirements /app/requirements

# Install app
RUN pip install --no-cache-dir -r requirements/dev.txt
RUN pip install --no-cache-dir -r requirements/docker.txt

COPY . /app

#TODO decide if collectstatic is needed (hopefully not)
#RUN ./manage.py collectstatic -l --noinput
